{% extends "base.html" %}

{% block content %}
<div class="max-w-5xl mx-auto my-5 p-2 bg-base-200 shadow-lg ">
    <div class="p-2 lg:p-5 rounded-xl border-2 border-solid border-primary">
        <h1 class="text-4xl font-bold text-center my-5">Doodle Classifier</h1>
        
        <!-- Drawing Canvas -->
        <div class="flex flex-col items-center">
            <canvas id="doodleCanvas" width="300" height="300" class="border-2 border-solid border-primary bg-white"></canvas>
            <div class="mt-3">
                <button id="clearCanvas" class="btn btn-error">Clear</button>
            </div>
        </div>

        <!-- Form -->
        <form method="POST" id="doodleForm" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="doodle_data" id="doodleData">
            <button type="submit" id="submit-btn" class="btn btn-primary w-full">Submit</button>
        </form>

        <!-- Previous Results -->
        <div class="mt-6">
            <h2 class="text-xl font-semibold mb-3 px-4">Previous Results</h2>
            <div class="join join-vertical w-full">
                {% for result in previous_results %}
                <div class="collapse collapse-arrow bg-base-100 rounded-lg shadow-md border-2 border-solid border-primary my-2 hover:border-secondary">
                    <input type="radio" name="results" />
                    <div class="collapse-title text-lg font-medium">
                        Submitted Doodle
                    </div>
                    <div class="collapse-content flex flex-col items-center justify-center">
                        <img src="data:image/png;base64,{{ result.input_data }}" class="w-32 h-32 border rounded-md shadow" alt="Doodle"/>
                        <div class="stats stats-vertical lg:stats-horizontal shadow mt-4">
                            <div class="stat place-items-center">
                              <div class="stat-title">Status</div>
                              <div class="stat-value text-primary">{{ result.status }}</div>
                              <div class="stat-desc">Pending | Processing | Completed</div>
                            </div>
                          
                            <div class="stat place-items-center">
                              <div class="stat-title">Prediction</div>
                              <div class="stat-value text-accent">{{ result.result.label }}</div>
                              <div class="stat-desc">Circle | Square | Triangle | Star</div>
                            </div>
                          
                            <div class="stat place-items-center">
                              <div class="stat-title">Confidence</div>
                              <div class="stat-value">{{ result.result.score|truncatechars:7 }}</div>
                              <div class="stat-desc">Between 0 to 1</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center">No previous results available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById("doodleCanvas");
    const ctx = canvas.getContext("2d");
    const doodleDataInput = document.getElementById("doodleData");
    let drawing = false;

    canvas.addEventListener("mousedown", () => { drawing = true; });
    canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });
    canvas.addEventListener("mousemove", draw);

    function draw(event) {
        if (!drawing) return;
        ctx.lineWidth = 5;
        ctx.lineCap = "round";
        ctx.strokeStyle = "black";
        ctx.lineTo(event.offsetX, event.offsetY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(event.offsetX, event.offsetY);
    }

    document.getElementById("clearCanvas").addEventListener("click", function () {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    // document.getElementById("doodleForm").addEventListener("submit", function () {
    //     doodleDataInput.value = canvas.toDataURL("image/png");
    // });


    document.getElementById("submit-btn").addEventListener("click", function () {
    let imageData = canvas.toDataURL("image/png"); // Get base64 data
    print("this is working")
        
    let formData = new FormData();
    formData.append("image_data", imageData);

    fetch("{% url 'doodle_classifier' %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    }).then(response => response.json())
      .then(data => console.log(data))
      .catch(error => console.error(error));
});

</script>
{% endblock %}
